var events = require('events');
var winston = require('winston');
var misc = require('./build/Release/misc');
misc.Pollpri.prototype.__proto__ = events.EventEmitter.prototype;

if(process.argv.length > 2) {
    var file = process.argv[2];
    var gpioPoll = new misc.Pollpri(file);
    var gpioHandler = function(value) {
        value = value.replace(/\s*$/, '');
        winston.info(''+value);
    };
    gpioPoll.on('edge', gpioHandler);
} else {
    var onMessage = function(m) {
        winston.debug('Attaching handler to ' + m.file);
        var gpioPoll = new misc.Pollpri(m.file);
        var gpioHandler = function(value) {
            //winston.debug('Got interrupt event');
            try {
                process.send({'value': value});
            } catch(ex) {
                winston.error('Unable to send message to parent process: ' + ex);
                process.exit(1);
            }
        };
        gpioPoll.on('edge', gpioHandler);
    };
    process.on('message', onMessage);
    winston.debug('Started GPIO interrupt listener');
}
